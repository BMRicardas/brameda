---
import { Image } from "astro:assets";

import type { Product } from "@/schemas/contentful-transformed.types";

import { ProductGallery } from "@/components/react/product-gallery/product-gallery";
import { getMainPhotoUrl } from "@/utils";

type Props = {
  product: Product;
};

const { product } = Astro.props;

const { slug, title, mainPhoto, videoUrl, variants, displayMode } = product;

const initialColor = variants[0]?.color;

const allVariantPhotos = variants.flatMap((variant) =>
  (variant.photos ?? []).map((photo, index) => ({
    ...photo,
    color: variant.color,
    altText: `${title} - ${variant.name} - Photo ${index + 1}`,
  }))
);

const shouldShowThumbnails = allVariantPhotos.length > 1;
const mainPhotoSrc = mainPhoto.url || allVariantPhotos[0]?.url || "";
const transitionName = `photo-${slug}`;
---

<div class="product-media">
  {
    shouldShowThumbnails ? (
      <ProductGallery
        client:visible
        displayMode={displayMode}
        initialColor={initialColor}
        photos={allVariantPhotos}
        transition:name={transitionName}
      />
    ) : (
      <div class="product__img" transition:name={transitionName}>
        <Image
          alt={title}
          class="main-image"
          data-color={initialColor}
          decoding="async"
          fetchpriority="high"
          inferSize
          loading="eager"
          sizes="(max-width: 768px) 100vw, 800px"
          src={getMainPhotoUrl(mainPhotoSrc, 100)}
        />
      </div>
    )
  }
  {
    videoUrl && (
      <div class="product__video">
        <iframe
          allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen={true}
          loading="lazy"
          src={videoUrl}
          title={`Video of ${title}`}
        />
      </div>
    )
  }
</div>

<style>
  .product-media {
    grid-area: media;
    min-width: 0;
  }

  .product__img {
    grid-area: img;
    flex: 1;
    background: var(--color-grey-light);
    border-radius: var(--border-radius);
    margin-bottom: 1.5rem;
    width: 100%;
    max-height: 50rem;
    overflow: clip;
    display: flex;
    justify-content: center;
    align-items: center;
    aspect-ratio: 1 / 1;

    & .main-image {
      width: 100%;
      height: 100%;
      max-height: 48rem;
      object-fit: contain;
      padding: var(--default-spacing);
    }
  }

  .product__video {
    grid-area: video;
    margin-top: 5rem;
    border-radius: var(--border-radius);
    overflow: clip;
    aspect-ratio: 16 / 9;
  }

  .product__video iframe {
    display: block;
    width: 100%;
    height: 35rem;
  }
</style>
